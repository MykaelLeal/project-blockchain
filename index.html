<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulário de Cadastro</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

</head>
<body>
  <main class="card">
    <h1>Formulário de Cadastro</h1>

    <!-- O formulário aponta para um handler em script.js via onsubmit -->
    <form id="cadastroForm">
      <div class="field">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" required autocomplete="name" />
      </div>

      <div class="field">
        <label for="idade">Idade</label>
        <input type="number" id="idade" name="idade" required min="0" />
      </div>

      <div class="field">
        <label for="cpf">CPF</label>
        <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" />
      </div>

      <div class="field">
        <label for="endereco">Endereço</label>
        <input type="text" id="endereco" name="endereco"/>
      </div>

      <div class="actions">
        <button type="submit" onclick="cadastrarPaciente()">Cadastrar</button>
        <button type="submit" onclick="verPaciente()">ver</button>
      </div>
    </form>
  </main>

  <!-- Referência para o arquivo script.js (crie esse arquivo na mesma pasta) -->
  <script>
    const contratoABI = [
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "pacientes",
      "outputs": [
        {
          "internalType": "string",
          "name": "nome",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "idade",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "cpf",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "endereco",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_nome",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "_idade",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_cpf",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_endereco",
          "type": "string"
        }
      ],
      "name": "cadastrarPaciente",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
];
const contratoEndereco = '0xd3b0a3F5289a90657012d03bBF12bdff756FAD2b';


async function cadastrarPaciente(){
    const web3 = new Web3('HTTP://127.0.0.1:7545');
    const contrato = new web3.eth.Contract(contratoABI, contratoEndereco);
    const nome = document.getElementById('nome').value;
    const idade = document.getElementById('idade').value;
    const cpf = document.getElementById('cpf').value;
    const endereco = document.getElementById('endereco').value;
    const contas = await web3.eth.getAccounts();
    contrato.methods.cadastrarPaciente(nome, idade, cpf, endereco).send({from: contas[0]})
      .send({ from: contas[0] })
      .then(res => console.log("OK:", res))
      .catch(err => console.error("ERRO REAL:", err));
}

async function verPaciente() {
    const web3 = new Web3('HTTP://127.0.0.1:7545');
    const contrato = new web3.eth.Contract(contratoABI, contratoEndereco);

    const contas = await web3.eth.getAccounts();

    const paciente = await contrato.methods.pacientes(contas[0]).call();

    console.log(paciente);
    alert(`Nome: ${paciente.nome}\nIdade: ${paciente.idade}\nCPF: ${paciente.cpf}`);
}
  </script>
</body>
</html>
