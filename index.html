<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulário de Cadastro</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

</head>
<body>
  <div class="form">
    <h1>Formulário de Cadastro</h1>
    <form id="cadastroForm">
      <div class="field">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome"/>
      </div>

      <div class="field">
        <label for="idade">Idade</label>
        <input type="number" id="idade" name="idade"/>
      </div>

      <div class="field">
        <label for="cpf">CPF</label>
        <input type="text" id="cpf" name="cpf"/>
      </div>

      <div class="field">
        <label for="endereco">Endereço</label>
        <input type="text" id="endereco" name="endereco"/>
      </div>

      <div class="actions">
        <button type="button-cadastrar" onclick="cadastrarPaciente()">Cadastrar</button>
      </div>
    </form>
</div>

<div class="listar-wrapper">
    <button onclick="verPacientes()">Listar pacientes</button>
</div>

<div id="listaPacientes" class="cards-container"></div>

  <script>
    const contratoABI = [
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "listaPacientes",
      "outputs": [
        {
          "internalType": "string",
          "name": "nome",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "idade",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "cpf",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "endereco",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "pacientes",
      "outputs": [
        {
          "internalType": "string",
          "name": "nome",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "idade",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "cpf",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "endereco",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_nome",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "_idade",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_cpf",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_endereco",
          "type": "string"
        }
      ],
      "name": "cadastrarPaciente",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "verTodosPacientes",
      "outputs": [
        {
          "components": [
            {
              "internalType": "string",
              "name": "nome",
              "type": "string"
            },
            {
              "internalType": "uint256",
              "name": "idade",
              "type": "uint256"
            },
            {
              "internalType": "string",
              "name": "cpf",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "endereco",
              "type": "string"
            }
          ],
          "internalType": "struct ContratoPaciente.Paciente[]",
          "name": "",
          "type": "tuple[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
];
const contratoEndereco = '';

let indiceConta = 0;
async function cadastrarPaciente(){
  const web3 = new Web3('HTTP://127.0.0.1:7545');
  const contrato = new web3.eth.Contract(contratoABI, contratoEndereco);

  const nome = document.getElementById('nome').value;
  const idade = document.getElementById('idade').value;
  const cpf = document.getElementById('cpf').value;
  const endereco = document.getElementById('endereco').value;

  const contas = await web3.eth.getAccounts();
  const contaUsada = contas[indiceConta];

  contrato.methods.cadastrarPaciente(nome, idade, cpf, endereco)
  .send({ from: contaUsada, gas: 800000 })
  .then(res => console.log("OK:", res))
  .catch(err => console.error("ERRO REAL:", err));
  indiceConta++;
}

async function verPacientes() {
  const web3 = new Web3('HTTP://127.0.0.1:7545');
  const contrato = new web3.eth.Contract(contratoABI, contratoEndereco);

  const pacientes = await contrato.methods.verTodosPacientes().call();
    
  const divLista = document.getElementById("listaPacientes");
  divLista.innerHTML = "";
  if (pacientes.length === 0) {
    divLista.innerHTML = "<p>Nenhum paciente cadastrado.</p>";
    return;
  }

   pacientes.forEach((p, i) => {
    divLista.innerHTML += `
      <div class="card">
          <h3>Paciente #${i + 1}</h3>
          <p><strong>Nome:</strong> ${p.nome}</p>
          <p><strong>Idade:</strong> ${p.idade}</p>
          <p><strong>CPF:</strong> ${p.cpf}</p>
          <p><strong>Endereço:</strong> ${p.endereco}</p>
      </div>`;
  });
}
  </script>
</body>
</html>
